# ZIPファイルアップロード ワークフロー解説

このドキュメントでは、ユーザーがガチャデータをZIP形式でアップロードして共有リンクを取得するまでの流れを、クライアント・API・データベースの3つの視点で説明します。技術に詳しくない方でも理解しやすいよう、ステップごとに噛み砕いて解説します。

## 全体の流れ
1. ユーザーが画面上でバックアップ用ZIPを作成し、アップロードボタンを押す。
2. ブラウザがCSRFトークンを取得して安全性を確認する。
3. ブラウザがアップロード許可（ポリシー）をAPIに申請する。
4. APIがVercel Blobへの一時的なアップロードトークンを発行し、ブラウザへ返す。
5. ブラウザがVercel Blobへ直接ZIPを送信する。
6. アップロード完了後、共有リンク発行APIを呼び出し、短い受け取りURLを取得する。
7. 共有リンク情報（暗号化トークン）がUpstashに保存され、ユーザーはリンクを受け取る。

## クライアント側の動き
実装の中心は `apps/web/src/features/save/useBlobUpload.ts` にあります。

1. **ZIPファイルの準備**
   - 画面上で選択されたアイテムから `buildUserZipFromSelection` などを用いてZIPを生成します。
   - ZIPのファイル名や宛先ユーザー名が入力されます。

2. **CSRFトークン取得**
   - `useBlobUpload` フックは最初に `/api/blob/csrf` を `GET` し、サーバーからCSRFトークンを受け取ります。
   - サーバーはクッキーにも同じ値を保存するので、以後のAPI呼び出しで「同じ値をボディに入れているか」を確認できます。

3. **アップロード許可の申請**
   - `/api/blob/upload` に `POST`（`action: "prepare-upload"`）して、以下の情報を送ります。
     - ユーザーID（サイト内での識別子）
     - ZIPファイル名
     - 共有先（受け取り人）に関するメタ情報
     - CSRFトークン
   - 応答には、Vercel Blobへ直接アップロードするための一時トークン (`token`) と保存先パス (`pathname`) が含まれます。

4. **Vercel Blobへの直接アップロード**
   - 返された `token` と `pathname` を使い、`@vercel/blob/client` の `put` 関数でブラウザから直接Vercel BlobストレージへZIPファイルを送信します。
   - 成功するとダウンロード用URL (`downloadUrl`) が返ってきます。

5. **共有リンクの発行**
   - ブラウザは `/api/receive/token` に `POST` し、`downloadUrl` と `fileName` を渡して共有用トークンの発行を依頼します。
   - 応答には `shareUrl`（ユーザーと共有する短いURL）と `token`（暗号化済みの実体）などが含まれます。

6. **結果表示**
   - フロントエンドは `shareUrl` をダイアログ等に表示し、ユーザーはURLをコピーして配布できます。

## API側の処理
実装は主に `apps/web/api/blob/*.js` と `apps/web/api/receive/*.js` にあります。

1. **/api/blob/csrf (GET)**
   - ランダムなCSRFトークンを生成し、`csrf` クッキーとJSONレスポンスで返します。
   - Double Submit Cookie方式で、ブラウザは以後のリクエスト本文に同じトークンを入れる必要があります。

2. **/api/blob/upload (POST)**
   - オリジン（アクセス元URL）をチェックし、許可されたドメインからの呼び出しかを確認。
   - CSRFトークンがクッキーと本文で一致するか検証。
   - ユーザーID、Discord ID、受け取り相手の名前などをサニタイズして安全なパスを生成。
   - Vercel Blob用のクライアントトークンを発行し、アップロード期限や許可MIMEタイプを設定。
   - 応答として `token`, `pathname`, 正規化した `fileName` などを返します。

3. **Vercel Blob**
   - 実際のファイルデータは当サイトのAPIを経由せず、ブラウザ→Vercel Blob へ直接送信されます。
   - この仕組みにより、APIサーバーの帯域消費やファイルサイズ制限の問題を軽減できます。

4. **/api/receive/token (POST)**
   - 再度オリジンとCSRFを確認し、第三者からの悪用を防ぎます。
   - `downloadUrl` が許可されたホスト（Vercel Blobドメイン）かをチェック。
   - 共有用メタデータ（ファイル名、目的など）と有効期限をまとめ、AES-256-GCM で暗号化したトークンを生成。
   - 暗号化トークンをそのまま返すほか、短縮トークンもUpstashに保存し、`/receive?t=xxxxx` 形式の共有URLを作成します。

5. **/api/receive/resolve (GET)**
   - 共有リンクにアクセスされた際に、短縮トークンをUpstashから取り出し、本来の暗号化トークンに変換。
   - トークンを復号し、期限切れかどうかを判定。
   - `redirect=1` が指定されていればVercel BlobのダウンロードURLに302リダイレクト、指定されていなければJSONで詳細を返します。

## データベース（Upstash Redis KV）での役割
ZIPアップロードに関連するキーは以下の通りです。

| キー形式 | 例 | 用途 | 保存期限 |
| --- | --- | --- | --- |
| `receive:token:{short}` | `receive:token:AbC123xyz` | 短縮トークン→暗号化トークンのマッピング。 | 共有リンクの有効期限まで（最大14日） |
| `sess:{sid}` | `sess:K9x...` | ログイン済みユーザーのセッション。アップロードAPIはクッキーの `sid` でログイン状態を確認します。 | 30日 |
| `discord:auth:{state}` | `discord:auth:...` | （ログイン経由の利用前提）Discordログインフローで使用。 | 10分 |

> **補足:** ZIPアップロード自体ではUpstashに大量のメタデータを保存しません。ファイル本体はVercel Blobにあり、共有リンク用の暗号化トークンのみが保存されます。

## セキュリティとバリデーション
- **CSRF対策**: すべてのPOSTリクエストでクッキーと本文のトークン一致を確認します。
- **オリジン制限**: 許可されたサイトからのリクエストのみ処理します。Refererが無い場合はHostヘッダーと比較します。
- **ファイル名サニタイズ**: 禁止文字を除去し、想定外の階層や長さにならないよう整形します。
- **コンテンツタイプ確認**: ZIP形式のMIMEタイプのみ許可し、不正ファイルのアップロードを防止します。
- **ダウンロード先制限**: 共有リンクは特定のホスト（Vercel Blobドメイン）のみ許可され、第三者サイトへの誘導を防ぎます。
- **暗号化トークン**: 共有リンクはAES-256-GCMで暗号化されており、トークンが漏れても中身を読み取れません。

## よくあるエラーと対処例
- **CSRFトークン不一致 (403)**: ブラウザのクッキー設定やキャッシュを確認し、`/api/blob/csrf` を再取得してからやり直してください。
- **Origin not allowed (403)**: 開発環境でURLが変わった場合、`NEXT_PUBLIC_SITE_ORIGIN` や `VERCEL_URL` が正しく設定されているか確認します。
- **Download host not allowed (403)**: Vercel Blob以外のURLを指定すると拒否されます。許可ドメイン一覧を環境変数 `ALLOWED_DOWNLOAD_HOST_SUFFIXES` で調整できます。
- **failed to allocate short token**: Upstashで短縮トークンが競合した際に発生する稀なエラー。再試行で解消することが多いです。

## 改善候補・課題
- `issueCsrfToken` のデフォルトドメインが `.shimmy3.com` 固定なので、開発環境では上書き設定が必要。環境ごとの設定ドキュメントを整備すると安全です。
- アップロード失敗時の詳細メッセージがユーザーに届きづらいため、クライアント側で `BlobUploadError` の `cause` を参照し、説明を補うUI改善が望まれます。
- 共有リンクの有効期限をユーザーが選べるようにする機能が未実装。`validUntil` の入力欄を追加することで柔軟性が向上します。
- Vercel Blobへのアップロードが大容量になると時間がかかるため、進行状況（プログレスバー）の表示があるとUXが向上します。

---
このワークフローを理解すれば、アップロード失敗時の原因切り分けや、共有機能の拡張（有効期限の延長、アクセス制御など）を行う際に役立ちます。
