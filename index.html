<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#000000">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
<title>ã‚¬ãƒãƒ£çµæœãƒ“ãƒ¥ãƒ¼ã‚¢ v15</title>

<!-- JSZipï¼ˆä¿å­˜ã§ä½¿ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
  if (typeof window.JSZip === "undefined") {
    const s = document.createElement("script");
    s.src = "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js";
    document.head.appendChild(s);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

<style>
  :root{
    --bg:#0b0b0f;--panel:#15151b;--panel-2:#1b1b22;--text:#f5f5f6;--muted:#b3b3bd;
    --accent:#e11d48;--accent-2:#9f1239;--border:#2a2a36;
    --shadow:0 6px 24px rgba(0,0,0,.35),0 2px 8px rgba(0,0,0,.5)
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1200px 600px at 20% -10%, rgba(225,29,72,.08), transparent 60%),
      radial-gradient(800px 500px at 100% 0%, rgba(225,29,72,.08), transparent 55%),
      var(--bg);
    color:var(--text);
    font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",Meiryo,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    line-height:1.6
  }
  h1,h2,h3{margin:0 0 .5rem}h1{font-size:1.7rem}h2{font-size:1.2rem}
  .container{max-width:1200px;margin:24px auto 64px;padding:0 16px}

  /* Buttons */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    font-size:1rem;line-height:1;min-height:42px;padding:.7rem 1rem;border-radius:10px;
    appearance:none;border:1px solid var(--accent);
    background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;
    font-weight:700;letter-spacing:.02em;cursor:pointer;box-shadow:var(--shadow);
    transition:transform .05s,filter .2s
  }
  .btn:active{transform:translateY(1px) scale(.995)}
  .btn.subtle{background:var(--panel-2);color:var(--text);border-color:var(--border);font-weight:600}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
  .btn.small{min-height:32px;padding:.45rem .7rem;font-size:.9rem}
  .btn[disabled]{opacity:.55;cursor:not-allowed;filter:saturate(.6)}

  .tag{display:inline-flex;align-items:center;gap:.45rem;background:#23232b;border:1px solid var(--border);color:#9aa;font-size:.85rem;padding:.2rem .55rem;border-radius:999px}
  .toolbar{background:linear-gradient(180deg, rgba(225,29,72,.12), rgba(225,29,72,.04) 40%, transparent);border:1px solid var(--border);border-radius:16px;padding:16px;display:grid;gap:12px;box-shadow:var(--shadow)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .file-drop{display:flex;gap:12px;align-items:center;flex-wrap:wrap;border:2px dashed rgba(225,29,72,.45);border-radius:12px;padding:12px;background:rgba(225,29,72,.06)}
  .file-drop.dragover{background:rgba(225,29,72,.12)}
  input[type="file"]::file-selector-button{appearance:none;border:1px solid var(--accent);background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;padding:.55rem .9rem;border-radius:10px;cursor:pointer;font-weight:700;line-height:1;margin-right:.6rem}
  input[type="file"]{color:var(--muted)}
  select{appearance:none;background:#0f1016;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:.55rem 2rem .55rem .7rem;font-weight:600;line-height:1;min-height:42px;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 20 20" fill="none" stroke="%23b3b3bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 8 10 12 14 8"/></svg>');
    background-repeat:no-repeat;background-position:right .6rem center;background-size:12px}
  select:focus{outline:2px solid rgba(225,29,72,.4);outline-offset:2px}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:16px}.two-col{grid-template-columns:1fr}@media(min-width:980px){.two-col{grid-template-columns:1fr 1fr}}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f1014;padding:.1rem .35rem;border-radius:6px;border:1px solid var(--border);color:#d1d5db}
  .muted{color:var(--muted)}.sep{height:1px;background:var(--border);margin:.75rem 0 1rem}
  .visually-hidden{position:absolute!important;inset:0 auto auto 0;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

  /* Tabs + item grid */
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:.45rem .75rem;border:1px solid var(--border);border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;background:#121218;color:var(--muted);cursor:pointer;user-select:none}
  .tab.active{background:#191922;color:#fff;border-color:var(--accent)}
  .item-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .item-card{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:190px;position:relative}
  .item-thumb{aspect-ratio:1/1;background:#0e0f14;border:1px dashed var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .item-thumb img{width:100%;height:100%;object-fit:contain;display:block}
  .item-code{font-weight:800;font-size:1.15rem;letter-spacing:.03em}
  .rarity{font-weight:700}.rarity.SSR{color:#fde68a}.rarity.SR{color:#a78bfa}.rarity.R{color:#93c5fd}.rarity.N{color:#a7f3d0}.rarity.ã¯ãšã‚Œ{color:#fca5a5}
  .card-actions{display:flex;gap:8px;flex-wrap:wrap}
  .card-actions .btn[data-action="primary"]{width:100%}
  .badge{font-size:.75rem;padding:.1rem .4rem;border-radius:.5rem;border:1px solid var(--border);background:#0e0f14;color:#a6a6b3}
  .flag{position:absolute;top:8px;right:10px;display:flex;gap:6px}
  .flag .skip{border-color:#e11d48;color:#fff;background:linear-gradient(180deg,#e11d48,#9f1239)}

  /* Users panel */
  .user-card{margin-bottom:16px;position:relative}
  .user-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .user-actions{display:flex;gap:8px;align-items:center}.user-actions .btn.small{min-width:110px}
  .gacha-box{background:var(--panel-2);border:1px dashed var(--border);border-radius:12px;padding:12px}
  .rarity-row{display:grid;grid-template-columns:3.6rem 1fr;column-gap:.6rem;align-items:start;margin-top:.25rem}
  .rarity-label{display:flex;align-items:center;font-weight:800;line-height:1.2;min-height:32px}
  .rarity-items{display:flex;flex-wrap:wrap;gap:.3rem .45rem}
  .item-pill{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .6rem;border-radius:999px;background:#23232b;border:1px solid var(--border)}
  .item-pill img{width:20px;height:20px;object-fit:contain;border-radius:4px;display:block}
  .item-pill.no-img{justify-content:center;padding:.25rem .8rem}

  /* All modals */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);padding:20px;z-index:50}
  .modal.show{display:grid}
  .dialog{width:min(880px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .dialog h3{margin:0 0 .5rem}
  .dialog .grid-2{display:grid;gap:12px;grid-template-columns:1fr}@media(min-width:860px){.dialog .grid-2{grid-template-columns:1fr 1fr}}

  /* Start splash */
  .splash{display:grid;place-items:center;min-height:60vh}
  .info-btn{width:26px;height:26px;border-radius:999px;border:1px solid var(--border);background:#0f1016;color:#cbd5e1;display:inline-flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer}
  .hint{color:#a1a1aa;font-size:.95rem}

  /* Paste areas */
  textarea{width:100%;min-height:180px;background:#0f1016;color:#f5f5f6;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  input[type="text"]{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid var(--border);background:#0f1016;color:#f5f5f6}

  /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åã¾ã‚Šã‚’å¼·åˆ¶ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
  #modalPreview{width:100%;height:100%; object-fit:contain;image-rendering:auto;}

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼å†…è¨³ã®å€‹æ•°è¡¨ç¤º */
  .item-pill .count{font-weight:700;color:#e5e7eb;margin-left:.15rem;}

  /* ã‚¿ãƒ–ã‚’ãƒ›ãƒãƒ¼ã§å¼·èª¿ */
  .tab{ position: relative; }
  .tab:hover{ background:#1f1f27; color:#fff; border-color: var(--accent); }

  /* ã‚¿ãƒ–å³ä¸Šã®Ã—ãƒœã‚¿ãƒ³ */
  .tab .close{position:absolute; top:-8px; right:-8px; width:20px; height:20px; display:flex; align-items:center; justify-content:center; border-radius:999px; background:#2a2a36; color:#cbd5e1; border:1px solid var(--border); font-weight:800; cursor:pointer;}
  .tab .close:hover{ background:#e11d48; color:#fff; border-color:#e11d48; }
  .tab { position: relative; }
  .tab .close{opacity: 0; pointer-events: none; transition: opacity .15s ease;}
  .tab:hover .close{ opacity: 1; pointer-events: auto; }

  /* å†è¨­è¨ˆãƒˆã‚°ãƒ«ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰å¼ï¼‰ */
  .toggle{display:inline-flex; align-items:center; gap:.5rem;padding:.2rem .5rem; background:#23232b; border:1px solid var(--border);border-radius:999px;}
  .toggle input.switch{appearance:none; width:44px; height:24px; border-radius:999px;background:#0f1016; border:1px solid var(--border);position:relative; outline:none; cursor:pointer;transition:background .2s,border-color .2s;}
  .toggle input.switch::after{content:""; position:absolute; top:2px; left:2px; width:18px; height:18px;border-radius:50%; background:#9ca3af; transition:left .2s, background .2s;}
  .toggle input.switch:checked{ background:#e11d48; border-color:#e11d48; }
  .toggle input.switch:checked::after{ left:24px; background:#fff; }
  .toggle .label{ font-weight:700; color:#cbd5e1; }

  /* JS ãŒ #mainUI ã« .mobile-views ã‚’ä»˜ä¸ã—ãŸæ™‚ã ã‘ãƒ¢ãƒã‚¤ãƒ«UIã«ã™ã‚‹ */
  #mainUI.mobile-views { padding-bottom: 98px; } /* ãƒœãƒˆãƒ ã‚¿ãƒ–åˆ†ã®ä½™ç™½ */

  #mainUI.mobile-views [data-page]{ display:none; }
  #mainUI.mobile-views[data-view="controls"] #controlsPage{ display:block; }
  #mainUI.mobile-views[data-view="items"]    #itemsPanel{ display:block; }
  #mainUI.mobile-views[data-view="users"]    #usersPanel{ display:block; }
  #mainUI.mobile-views[data-view="riagu"]    #skipPanel { display:block; } /* NEW */

  /* ãƒœãƒˆãƒ ã‚¿ãƒ–ï¼šé€šå¸¸ã¯éè¡¨ç¤ºã€mobile-views æ™‚ã®ã¿è¡¨ç¤º */
  .mobile-tabs{ display:none; }
  #mainUI.mobile-views .mobile-tabs{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 60;
    display:flex; gap:8px; padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    background: rgba(10,10,14,.9); backdrop-filter: blur(6px);
    border-top: 1px solid var(--border);
  }
  #mainUI.mobile-views .mobile-tabs button{
    flex:1 1 0; min-height:56px; border-radius:12px; border:1px solid var(--border);
    background:#15151b; color:#cbd5e1; font-weight:700;
  }
  #mainUI.mobile-views .mobile-tabs button.active{ border-color: var(--accent); color:#fff; }

  /* --- ãƒ¢ãƒã‚¤ãƒ«æ™‚ï¼šã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã‚’æ¨ªé•·ã« --- */
  #mainUI.mobile-views #itemGrid{ grid-template-columns: 1fr; gap:12px; }
  #mainUI.mobile-views .item-card{
    /* 2ã‚«ãƒ©ãƒ ã®æ¨ªé•·ã‚°ãƒªãƒƒãƒ‰ã€‚å·¦ã«æ­£æ–¹å½¢ã‚µãƒ ãƒã€å³ã«æƒ…å ± */
    display:grid;
    grid-template-columns:110px 1fr;
    grid-template-rows:auto auto auto auto;
    grid-template-areas:
      "thumb flag"    /* â† å³ä¸Šã«ãƒãƒƒã‚¸ï¼ˆé‡ãªã‚‰ãªã„å°‚ç”¨è¡Œï¼‰ */
      "thumb title"
      "thumb rarity"
      "thumb actions";
    align-items:center;
    gap:8px;
    padding:8px;
    min-height:110px;   /* ã‚µãƒ ãƒã¨é«˜ã•ã‚’åˆã‚ã›ã‚‹ */
  }
  /* ã‚µãƒ ãƒï¼ˆå·¦ï¼‰ */
  #mainUI.mobile-views .item-card .item-thumb{grid-area:thumb; width:100%; max-width:110px; aspect-ratio:1/1;}

  /* å³ä¸Šã®ãƒãƒƒã‚¸è¡Œï¼šabsolute ã‚’è§£é™¤ã—ã¦å°‚ç”¨ã‚»ãƒ«ã«ç½®ãï¼ˆé‡ãªã‚Šé˜²æ­¢ï¼‰ */
  #mainUI.mobile-views .item-card .flag{ grid-area:flag; position:static !important; justify-self:end; align-self:start; margin:0;}
  #mainUI.mobile-views .item-card .badge{ font-size:.72rem; padding:.05rem .35rem; border-radius:.4rem;}

  /* ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆitem-codeï¼‰ã‚’çœç•¥è¨˜å·ã§1è¡Œã« */
  #mainUI.mobile-views .item-card .item-code{ grid-area:title; font-size:1.05rem; line-height:1.2; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

  /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®è¡Œã‚’å°‘ã—å°ã•ãã‚¿ã‚¤ãƒˆã« */
  #mainUI.mobile-views .item-card > .muted{ grid-area:rarity; margin-top:2px; }
  #mainUI.mobile-views .item-card .rarity{ font-size:.9rem; }

  /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç”»åƒè¨­å®š / ãƒªã‚¢ã‚°ï¼‰ã¯æ¨ªä¸¦ã³ãƒ»ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  #mainUI.mobile-views .item-card .card-actions{ grid-area:actions; display:flex; gap:6px; margin-top:2px;}
  #mainUI.mobile-views .item-card .card-actions .btn{ flex:1 1 0; min-height:36px; padding:.45rem .7rem; font-size:.95rem; border-radius:10px;}
  #mainUI.mobile-views .item-card .card-actions .btn.ghost{ font-size:.9rem;}

  /* æ­£æ–¹å½¢ã‚¿ã‚¤ãƒ«é…ç½®ï¼šPC 4åˆ— / ãƒ¢ãƒã‚¤ãƒ« 2x2 */
  .start-grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(4, minmax(0,1fr));
  }
  @media (max-width: 900px){
    .start-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  .start-tile{
    position:relative; aspect-ratio:1/1;
    border:1px solid var(--border); border-radius:16px;
    background:linear-gradient(180deg,#1a1a22,#14141a);
    box-shadow: 0 2px 10px rgba(0,0,0,.25);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; cursor:pointer;
  }
  .start-tile .title{ font-weight:800; font-size:1.05rem; color:#fff; }
  .start-tile .sub{ font-size:.85rem; color:#cbd5e1; text-align:center; line-height:1.3 }
  .start-tile .info{
    position:absolute; top:8px; right:8px; width:22px; height:22px;
    border-radius:999px; background:#2a2a36; color:#cbd5e1;
    display:flex; align-items:center; justify-content:center; font-weight:800;
    border:1px solid var(--border);
  }
  .start-tile:hover{ outline:1px solid var(--accent); }
</style>
</head>
<body>
  <div class="container">
    <header style="margin-bottom:16px">
      <h1>ã‚¬ãƒãƒ£çµæœãƒ“ãƒ¥ãƒ¼ã‚¢ <span class="tag">é»’Ã—èµ¤</span> <span class="tag">v15</span></h1>
      <div class="muted">é–‹å§‹ãƒœã‚¿ãƒ³ â†’ <b>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </b> / <b>æœ€çµ‚çµæœè²¼ä»˜</b> / <b>JSONèª­è¾¼</b> ã‚’é¸æŠã€‚è§£æå¾Œã¯å¾“æ¥UIã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚</div>
    </header>

    <!-- Splash -->
    <section id="splash" class="splash">
      <button class="btn" id="openStart">é–‹å§‹ã™ã‚‹</button>
      <div class="hint" style="margin-top:.5rem">â€» å¾Œã‹ã‚‰ã§ã‚‚JSONèª­è¾¼ã¯å¯èƒ½ã§ã™</div>
    </section>

    <!-- Main UI (hidden until start/loaded) -->
    <section id="mainUI" style="display:none">
      <section class="toolbar" id="controlsPage" data-page="controls">
        <div class="row file-drop" id="dropzone mainControls">
        <div class="tag" id="summaryTag">æœªèª­è¾¼</div>
        <div style="flex:1"></div>

        <div class="toggle"><input type="checkbox" id="hideMiss" class="switch"><span class="label">ã¯ãšã‚Œã‚’éš ã™</span></div>
        <div class="toggle"><input type="checkbox" id="showCounts" class="switch"><span class="label">ç²å¾—æ•°ã‚’è¡¨ç¤º</span></div>
        <div class="toggle"><input type="checkbox" id="showSkipOnly" class="switch"><span class="label">ãƒªã‚¢ã‚°ã®ã¿ã‚’è¡¨ç¤º</span></div>

        <label for="filterRarity">ãƒ¬ã‚¢åº¦:</label>
        <select id="filterRarity" class="select"></select>

        <label for="userSearch">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢:</label>
        <input id="userSearch" type="text" placeholder="åå‰ã§æ¤œç´¢..." style="max-width:260px" />

        <button class="btn subtle" id="exportMapBtn">ç”»åƒãƒãƒƒãƒ—ã‚’æ›¸ãå‡ºã—</button>
        <label class="btn ghost" for="importMapInput">ç”»åƒãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€</label>
        <input type="file" id="importMapInput" accept="application/json,.json" style="display:none" />
        <button class="btn ghost" id="clearMapBtn">ç”»åƒãƒãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

        <button class="btn" id="openLivePaste" title="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’é–‹ã">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›</button>
        <button class="btn" id="openAppend" title="æœ€çµ‚å±¥æ­´ã‚’æ—¢å­˜ã‚¬ãƒãƒ£ã¸è¿½åŠ ">å±¥æ­´ã‚’è¿½åŠ ã™ã‚‹</button>
      </div>
      </section>

      <div class="grid two-col" style="margin-top:16px">
        <section class="panel" id="itemsPanel" data-page="items">
          <h2 style="margin-bottom:.25rem">ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒã®è¨­å®š</h2>
          <div class="muted" style="margin-bottom:8px">ã‚¿ãƒ–ã§ã‚¬ãƒãƒ£ã‚’åˆ‡æ›¿ã€‚<span class="kbd">ãƒ¬ã‚¢åº¦:ç¨®é¡</span>ã”ã¨ã«è¨­å®šã€‚</div>
          <div class="tabs" id="gachaTabs"></div>
          <div id="itemGrid" class="item-grid"></div>
        </section>

        <section class="panel" id="usersPanel" data-page="users">
          <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ç²å¾—å†…è¨³</h2>
          <div class="muted">å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å³ä¸Šã®<b>ä¿å­˜</b>ã§ZIPã‚’ç„¡åœ§ç¸®å‡ºåŠ›ï¼ˆå“è³ªãã®ã¾ã¾ï¼‰ã€‚</div>
          <div class="sep"></div>
          <div class="row" style="align-items:center; margin-bottom:8px">
            <label for="filterGacha">ã‚¬ãƒãƒ£çµã‚Šè¾¼ã¿:</label>
            <select id="filterGacha" class="select"><option value="*">ã™ã¹ã¦</option></select>
          </div>
          <div id="usersList"></div>
        </section>

        <section class="panel" id="skipPanel" data-page="riagu">
          <h2>ãƒªã‚¢ã‚°</h2>
          <div class="muted">ã“ã“ã«ã€Œãƒªã‚¢ã‚°ã€ã«è¨­å®šã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆæº–å‚™ä¸­ï¼‰</div>
        </section>
      </div>
      
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœãƒˆãƒ ãƒŠãƒ“ -->
      <nav id="mobileTabs" class="mobile-tabs" aria-label="ç”»é¢åˆ‡ã‚Šæ›¿ãˆ">
        <button type="button" data-view="controls" class="active">è¨­å®š</button>
        <button type="button" data-view="items">ã‚¢ã‚¤ãƒ†ãƒ </button>
        <button type="button" data-view="users">ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
        <button type="button" data-view="riagu">ãƒªã‚¢ã‚°</button>
      </nav>
    </section>
  </div>

  <!-- Start Modal -->
  <div class="modal" id="startModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <h3 id="startTitle">ã¯ã˜ã‚ã«</h3>

      <div class="muted" style="margin-bottom:10px">
        <p>ã“ã®ã‚µã‚¤ãƒˆã¯ã€ä»–ã‚µãƒ¼ãƒ“ã‚¹ã§å¼•ã„ãŸã‚¬ãƒãƒ£çµæœã‚’<strong>è¦‹ã‚„ã™ãé›†è¨ˆãƒ»å…±æœ‰</strong>ã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ã™ã€‚</p>
        <ul style="margin:.3rem 0 .6rem 1.2rem;line-height:1.5">
          <li>ã¾ãšã¯ <strong>è¨­å®šãƒ‡ãƒ¼ã‚¿</strong>ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ï¼‰ã‹ <strong>æœ€çµ‚å±¥æ­´</strong> ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚</li>
          <li>å¤–éƒ¨ã‚µã‚¤ãƒˆã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ <code>.txt</code>ï¼ˆbase64ï¼‰ã‚„æœ¬ãƒ„ãƒ¼ãƒ«ã® <code>.json</code> ã‚’ãã®ã¾ã¾å–ã‚Šè¾¼ã‚ã¾ã™ã€‚</li>
          <li>é€”ä¸­çµŒéã¯ã€Œãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã€ã‹ã‚‰ã©ã‚“ã©ã‚“è²¼ã‚Šä»˜ã‘å¯èƒ½ã€‚</li>
        </ul>
        <p>è¿·ã£ãŸã‚‰ <strong>ã€ŒTXTã‚’èª­ã¿è¾¼ã‚€ã€</strong>ã‹ã‚‰å§‹ã‚ã‚‹ã®ãŒç°¡å˜ã§ã™ã€‚</p>
      </div>

      <!-- å››è§’ã„ã‚¿ã‚¤ãƒ«ç¾¤ -->
      <div class="start-grid">
        <button class="start-tile" id="tileTxt">
          <span class="title">TXTã‚’èª­ã¿è¾¼ã‚€</span>
          <span class="sub">å¤–éƒ¨ã‚µã‚¤ãƒˆã®<br>base64ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
          <span class="info" title="ä»–ã‚µã‚¤ãƒˆã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸ .txtï¼ˆbase64ï¼‰ã‚’é¸ã¶ã¨ã€è¨­å®šã¨å±¥æ­´ã‚’ã¾ã¨ã‚ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚">i</span>
        </button>

        <button class="start-tile" id="tileJson">
          <span class="title">JSONã‚’èª­ã¿è¾¼ã‚€</span>
          <span class="sub">ã“ã®ãƒ„ãƒ¼ãƒ«å½¢å¼</span>
          <span class="info" title="æœ¬ãƒ„ãƒ¼ãƒ«ãŒå‡ºåŠ›ã™ã‚‹ gacha_summary.json ãªã©ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚">i</span>
        </button>

        <button class="start-tile" id="tileLive">
          <span class="title">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²è¡Œ</span>
          <span class="sub">è¨­å®šâ†’é€æ¬¡è²¼ä»˜</span>
          <span class="info" title="ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ï¼ˆè¨­å®šï¼‰ã‚’è²¼ã‚Šä»˜ã‘â†’ä»¥å¾Œã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®çµæœãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦é›†è¨ˆã—ã¾ã™ã€‚">i</span>
        </button>

        <button class="start-tile" id="tileFinal">
          <span class="title">æœ€çµ‚å±¥æ­´ã‚’è²¼ä»˜</span>
          <span class="sub">æœ€å¾Œã«ä¸€æ‹¬åæ˜ </span>
          <span class="info" title="æœ€çµ‚çš„ã«å‡ºåŠ›ã•ã‚ŒãŸä¸€è¦§ã‚’è²¼ã‚Šä»˜ã‘ã€é›†è¨ˆã«ä¸€æ‹¬åæ˜ ã—ã¾ã™ã€‚">i</span>
        </button>
      </div>

      <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆJSON / TXTï¼‰ -->
      <input type="file" id="jsonFile2" accept="application/json,.json" class="visually-hidden" />
      <input type="file" id="txtFileInput" accept=".txt,text/plain" class="visually-hidden" /> 
    </div>
  </div>

  <!-- Catalog Paste Modalï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ -->
  <div class="modal" id="catalogModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="catTitle">
      <h3 id="catTitle">å‡ºç¾ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ã®è²¼ã‚Šä»˜ã‘</h3>
      <div class="muted">å½¢å¼ä¾‹ï¼š<span class="kbd">No./ãƒ¬ã‚¢ãƒªãƒ†ã‚£/å‡ºç¾ç‡/æ™¯å“å</span>ï¼ˆç¸¦ä¸¦ã³ or ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰</div>
      <div class="sep"></div>
      <label>ã‚¬ãƒãƒ£å</label>
      <input id="catGachaName" type="text" placeholder="ä¾‹ï¼šã‚„ã¿ãƒã‚¬ãƒãƒ£" />
      <div style="height:.5rem"></div>
      <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <textarea id="catText" placeholder="ã“ã“ã«ä¸€è¦§ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn subtle" id="catParse">è§£æã—ã¦åæ˜ </button>
        <button class="btn ghost" id="catClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- NEW: æ¡ˆå†…ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœã¯ä¸Šéƒ¨ãƒœã‚¿ãƒ³ã‹ã‚‰ï¼‰ -->
  <div class="modal" id="guideModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="guideTitle">
      <h3 id="guideTitle">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
      <div class="muted">
        ã‚¬ãƒãƒ£çµæœã¯ç”»é¢ä¸Šéƒ¨ã®<strong>ã€Œãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã€</strong>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
      </div>
      <div class="sep"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="guideOk">åˆ†ã‹ã£ãŸ</button>
      </div>
    </div>
  </div>

  <!-- Live Paste Panelï¼ˆéšæ™‚ï¼‰ -->
  <div class="modal" id="liveModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="liveTitle">
      <h3 id="liveTitle">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœã‚’è²¼ã‚Šä»˜ã‘</h3>
      <div class="muted">å½¢å¼ä¾‹ï¼š<span class="kbd">ã‚¬ãƒãƒ£å</span> â†’ <span class="kbd">åå‰100é€£</span> â†’ <span class="kbd">ã€Rã€‘Cã€€4å€‹</span>â€¦ â†’ <span class="kbd">#ãªã¾ãšã¤ãƒ¼ã‚‹ãš</span></div>
      <div class="sep"></div>
      <textarea id="liveText" placeholder="ã“ã“ã«çµæœãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ï¼ˆè¤‡æ•°ãƒ–ãƒ­ãƒƒã‚¯å¯ï¼‰"></textarea>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn subtle" id="liveApply">åæ˜ </button>
        <button class="btn ghost" id="liveClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Final Paste Modal -->
  <div class="modal" id="finalModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
      <h3 id="finalTitle">æœ€çµ‚çš„ãªã‚¬ãƒãƒ£å±¥æ­´ã®è²¼ã‚Šä»˜ã‘</h3>
      <div class="muted">å…ˆé ­ã®ãƒ˜ãƒƒãƒ€ï¼ˆ<span class="kbd">ã‚¬ãƒãƒ£ / No. åå‰ / No. ãƒ¬ã‚¢ãƒªãƒ†ã‚£ æ™¯å“å ã‚ãŸã‚Šæ•°</span>ï¼‰ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
      <div class="sep"></div>
      <label>ã‚¬ãƒãƒ£åï¼ˆæœªæŒ‡å®šãªã‚‰ã€Œã‚¬ãƒãƒ£ã€ï¼‰</label>
      <input id="finalGachaName" type="text" placeholder="ä¾‹ï¼šã‚„ã¿ãƒã‚¬ãƒãƒ£" />
      <div style="height:.5rem"></div>
      <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <textarea id="finalText" placeholder="ã“ã“ã«æœ€çµ‚ä¸€è¦§ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn subtle" id="finalParse">è§£æã—ã¦åæ˜ </button>
        <button class="btn ghost" id="finalClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Image modalï¼ˆæ—¢å­˜ï¼‰ -->
  <div class="modal" id="imageModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">ç”»åƒã‚’è¨­å®š</h3>
      <div class="muted" id="modalSubtitle">å¯¾è±¡: <span class="tag" id="modalTarget"></span></div>
      <div class="sep"></div>
      <div class="grid-2">
        <div class="preview-box" style="background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px;display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center">
          <div class="thumb" style="width:120px;aspect-ratio:1/1;background:#0e0f14;border:1px dashed var(--border);border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">
            <img id="modalPreview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
          </div>
          <div>
            <div class="muted" style="margin-bottom:.25rem">ç¾åœ¨ã®ç”»åƒ</div>
            <div class="tag" id="modalStatus">æœªè¨­å®š</div>
          </div>
        </div>
        <div>
          <label for="fileInput">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</label>
          <input id="fileInput" type="file" accept="image/*,video/*,audio/*,.mp4,.mp3" />
          <div style="height:.5rem"></div>
          <label for="urlInput">ç”»åƒURLï¼ˆç”»åƒ/å‹•ç”»/éŸ³å£°ï¼‰</label>
          <input id="urlInput" type="text" placeholder="https://example.com/image.png" />
          <div style="height:.5rem"></div>
          <button class="btn" id="applyBtn">ä¿å­˜</button>
          <button class="btn ghost" id="closeBtn">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="muted">è¡¨ç¤ºã¯ã‚µãƒ ãƒã€ZIPã¯ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼ˆURLå–å¾—ä¸å¯ã¯é™¤ãï¼‰ã€‚</div>
    </div>
  </div>

  <!-- NEW: ã‚¬ãƒãƒ£å‰Šé™¤ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="deleteModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="delTitle">
      <h3 id="delTitle">ã‚¬ãƒãƒ£ã‚’å‰Šé™¤</h3>
      <div class="muted">ä»¥ä¸‹ã®ã‚¬ãƒãƒ£ã‚’å‰Šé™¤ã—ã¾ã™ï¼š <span class="tag" id="delTarget"></span><br>ã“ã®ã‚¬ãƒãƒ£ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é›†è¨ˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div>
      <div class="sep"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn ghost" id="delCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" id="delConfirm">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <div class="modal" id="appendModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="appendTitle">
      <h3 id="appendTitle">å±¥æ­´ã‚’è¿½åŠ ã™ã‚‹</h3>
      <div class="muted">æœ€çµ‚çš„ãªã‚¬ãƒãƒ£å±¥æ­´ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è²¼ã‚Šä»˜ã‘ã€‚ã‚¬ãƒãƒ£åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      <div class="sep"></div>
      <label for="appendGacha">ã‚¬ãƒãƒ£å</label>
      <select id="appendGacha" class="select"></select>
      <div style="height:.5rem"></div>
      <label for="appendText">ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <textarea id="appendText" placeholder="æœ€çµ‚å±¥æ­´ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn subtle" id="appendApply">åæ˜ </button>
        <button class="btn ghost" id="appendClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
/* ====== å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
const baseRarityOrder = ["UR","SSR","SR","R","N","ã¯ãšã‚Œ"];
let gRarityOrder = [...baseRarityOrder];
const keyOf = (gacha, rarity, code) => `${gacha}::${rarity}::${code}`;
const legacyKey = (rarity, code) => `${rarity}::${code}`;
const stripGacha = (key) => { const p = String(key).split("::"); return p.length===3 ? `${p[1]}::${p[2]}` : key; };
const byRarityThenCode = (a,b)=>{const ra = gRarityOrder.indexOf(a.rarity);const rb = gRarityOrder.indexOf(b.rarity);if(ra !== rb) return ra - rb;return (a.code||'').localeCompare(b.code||'ja');};
const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const sanitize = s => String(s).replace(/[\\/:*?"<>|]+/g, "_").replace(/\s+/g, "_");
const uniqPush = (arr, v) => { if(!arr.includes(v)) arr.push(v); };

/* ====== ç”»åƒä¿å­˜ç³»ï¼ˆæ—¢å­˜ï¼‰ ====== */
let gData = {};                     // { user: { gacha: { pulls:int, items:{rarity:[code...]}}}}
let gCatalogByGacha = {};           // { gacha: [{gacha,rarity,code}, ...]} â† è¿½åŠ ï¼šã‚«ã‚¿ãƒ­ã‚°å®šç¾©
let gAllGachas=[], gItemsByGacha={}, selectedGacha=null, currentModalTarget=null;
let gHitCounts = {};

const LS_KEY_IMG="gacha_item_image_map_v1";
const LS_KEY_SKIP="gacha_item_image_skip_v1";
const LS_KEY_ORIG="gacha_item_original_v1";
function loadLocalJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
function saveLocalJSON(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); return true; } catch(e){ if(e && (e.name==="QuotaExceededError"||e.code===22)){ console.warn("quota",key); return false; } throw e; } }
let imgMap=loadLocalJSON(LS_KEY_IMG,{}), origMap=loadLocalJSON(LS_KEY_ORIG,{}), skipSet=new Set(loadLocalJSON(LS_KEY_SKIP,[]));
const skipHas=(key)=>skipSet.has(key)||skipSet.has(stripGacha(key));
const skipAdd=(key)=>{ skipSet.add(key); skipSet.delete(stripGacha(key)); saveLocalJSON(LS_KEY_SKIP,Array.from(skipSet)); };
const skipDel=(key)=>{ skipSet.delete(key); skipSet.delete(stripGacha(key)); saveLocalJSON(LS_KEY_SKIP,Array.from(skipSet)); };

const DB_NAME="gachaImagesDB", STORE="images";
function idbOpen(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE)}; r.onsuccess=e=>res(e.target.result); r.onerror=e=>rej(e.target.error); });}
async function idbPut(key,blob){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).put(blob,key); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); });}
async function idbGet(key){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,"readonly"); const rq=tx.objectStore(STORE).get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error); });}
async function idbDelete(key){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).delete(key); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); });}
async function idbClear(){ const db=await idbOpen(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).clear(); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); });}
const urlCache=new Map(); async function urlForKey(key){ if(urlCache.has(key)) return urlCache.get(key); const blob=await idbGet(key); if(!blob) return ""; const url=URL.createObjectURL(blob); urlCache.set(key,url); return url; }

function lookupVal(map,key){ if(map[key]) return map[key]; const leg=stripGacha(key); return map[leg]||""; }
function immediateSrcFor(key){ const v=lookupVal(imgMap,key); if(!v) return ""; if(v.startsWith("idb:")) return ""; return v; }
function thumbInnerHTML(it){ const key=keyOf(it.gacha,it.rarity,it.code); const src=immediateSrcFor(key); return src?`<img src="${src}" alt="${escapeHtml(it.code)}" />`:`<span class="muted">No Image</span>`; }

// ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸å¯
document.body.classList.add('splash-locked');

/* ====== JSON èª­ã¿è¾¼ã¿ï¼UI å†æç”» ====== */
function handleFiles(files){ if(!files||!files.length) return; const f=files[0]; const rd=new FileReader(); rd.onload=()=>{ try{ onJsonLoaded(JSON.parse(rd.result)); startDone(); }catch(err){ alert("JSONã®è§£æã«å¤±æ•—: "+err.message);} }; rd.readAsText(f,"utf-8"); }

const drop=$("#dropzone");
if (drop) {
  drop.addEventListener("dragover",(e)=>{e.preventDefault();drop.classList.add("dragover")});
  drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
  drop.addEventListener("drop",(e)=>{e.preventDefault();drop.classList.remove("dragover");handleFiles(e.dataTransfer.files)});
}
$("#loadJsonBtn")?.addEventListener("click",()=>handleFiles($("#jsonFile").files));

// ---- mobile åˆ¤å®š & åˆ‡æ›¿ï¼ˆmainUI ã‚’å®‰å…¨ã«å–å¾—ã—ã¦ã‹ã‚‰å‹•ã‹ã™ï¼‰ ----
let __mainUI = null;
function getMainUI(){ return __mainUI || (__mainUI = document.getElementById('mainUI')); }

// â€œãƒ¢ãƒã‚¤ãƒ«ç›¸å½“â€ã‚’ç’°å¢ƒã¨å¹…ã®ä¸¡é¢ã§åˆ¤å®š
function isMobileLike(){
  return window.matchMedia('(max-width: 900px), (hover: none) and (pointer: coarse)').matches;
}

function syncMobileTabs(){
  const main = getMainUI(); if(!main) return;
  const view = main.getAttribute('data-view') || 'controls';
  document.querySelectorAll('#mobileTabs button').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('data-view') === view);
  });
}


function updateMobileViewMode(){
  const main = getMainUI();        // â† ã“ã“ã§å–å¾—ï¼ˆã¾ã ç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
  if (!main) return;
  const mobile = isMobileLike();
  if (mobile) {
    main.classList.add('mobile-views');
    if (!main.getAttribute('data-view')) main.setAttribute('data-view','controls'); // â† æ—¢å®šã‚’ã€Œè¨­å®šã€
  } else {
    main.classList.remove('mobile-views');
    main.removeAttribute('data-view');
  }
  syncMobileTabs();
}

// DOM æ§‹ç¯‰å¾Œã«åˆå›å®Ÿè¡Œï¼ˆæ—©ã™ãã‚‹å‘¼ã³å‡ºã—ã‚’é˜²æ­¢ï¼‰
document.addEventListener('DOMContentLoaded', updateMobileViewMode);
window.addEventListener('resize', updateMobileViewMode);
window.addEventListener('orientationchange', updateMobileViewMode);

$$(".modal").forEach(m=>{
  m.addEventListener("touchmove", e=>{ if(e.target === m) e.preventDefault(); }, {passive:false});
});

$("#mobileTabs")?.addEventListener("click", (e)=>{
  const b = e.target.closest('button[data-view]'); if(!b) return;
  const view = b.getAttribute('data-view');
  mainUI.setAttribute('data-view', view);
  $$("#mobileTabs button").forEach(x=>x.classList.toggle('active', x===b));
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¸Šã«
  syncMobileTabs();
  window.scrollTo({top:0, behavior:'smooth'});
});

function incCount(user, gacha, rarity, code, by=1){
  if(!user || !gacha || !rarity || !code) return;
  gHitCounts[user] = gHitCounts[user] || {};
  gHitCounts[user][gacha] = gHitCounts[user][gacha] || {};
  gHitCounts[user][gacha][rarity] = gHitCounts[user][gacha][rarity] || {};
  gHitCounts[user][gacha][rarity][code] = (gHitCounts[user][gacha][rarity][code] || 0) + (by||0);
}

function onJsonLoaded(data){
  gData = data || {};
  rebuildGachaCaches();
  renderTabs();
  renderItemGrid();
  renderUsersList();
}

function rebuildGachaCaches(){
  // gItemsByGacha: gData ç”±æ¥ã®ã‚¢ã‚¤ãƒ†ãƒ 
  const perGachaMap = {};
  let usersCount=0, gachaEntries=0, itemUniqueTotal=0;

  Object.entries(gData).forEach(([user,gobj])=>{
    usersCount++;
    Object.entries(gobj).forEach(([gacha,info])=>{
      gachaEntries++;
      if(!perGachaMap[gacha]) perGachaMap[gacha]=new Map();
      Object.entries(info.items||{}).forEach(([rarity,arr])=>{
        (arr||[]).forEach(code=>{
          const k=keyOf(gacha,rarity,code);
          if(!perGachaMap[gacha].has(k)) perGachaMap[gacha].set(k,{gacha,rarity,code});
        });
      });
    });
  });

  // ã¾ãšå…¨ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’åé›†ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‹ã‚«ã‚¿ãƒ­ã‚°ï¼‰
  const raritySet = new Set();
  Object.values(perGachaMap).forEach(map => map.forEach(it => raritySet.add(it.rarity)));
  Object.values(gCatalogByGacha).forEach(arr => (arr||[]).forEach(it => raritySet.add(it.rarity)));

  // â˜… å‹•çš„ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †ã‚’æ±ºå®šï¼šåŸºæœ¬é † â†’ æœªçŸ¥ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§å¾Œç½®
  const customRarities = Array.from(raritySet).filter(r => !baseRarityOrder.includes(r)).sort((a,b)=>a.localeCompare(b,'ja'));
  gRarityOrder = [
    ...baseRarityOrder.filter(r => raritySet.has(r)),
    ...customRarities,
  ];

  // gItemsByGacha ã‚’ä½œæˆï¼ˆä¸¦ã³ã¯ gRarityOrder ã«å¾“ã†ï¼‰
  const gSet = new Set([...Object.keys(perGachaMap), ...Object.keys(gCatalogByGacha)]);
  gItemsByGacha = {};
  gSet.forEach(g=>{
    const fromData = Array.from(perGachaMap[g]?.values()||[]);
    const fromCat  = Array.from((gCatalogByGacha[g]||[]).values());
    const map = new Map();
    [...fromData, ...fromCat].forEach(it=>map.set(keyOf(it.gacha,it.rarity,it.code), it));
    const arr = Array.from(map.values()).sort(byRarityThenCode);
    gItemsByGacha[g] = arr;
    itemUniqueTotal += arr.length;
  });
  gAllGachas = Array.from(gSet);

  if(!selectedGacha) selectedGacha = gAllGachas[0] || null;

  // æ¦‚è¦
  $("#summaryTag").textContent = `${Object.keys(gData).length}ãƒ¦ãƒ¼ã‚¶ãƒ¼ / ${gSet.size}ã‚¬ãƒãƒ£ / ${itemUniqueTotal}ã‚¢ã‚¤ãƒ†ãƒ `;

  // ã‚¬ãƒãƒ£çµã‚Šè¾¼ã¿ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  const selG=$("#filterGacha");
  if(selG) selG.innerHTML='<option value="*">ã™ã¹ã¦</option>'+gAllGachas.map(g=>`<option>${g}</option>`).join("");

  // â˜… ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚»ãƒ¬ã‚¯ãƒˆã‚‚å‹•çš„ã«æ›´æ–°
  const selR=$("#filterRarity");
  if(selR){
    selR.innerHTML = '<option value="*">ã™ã¹ã¦</option>' + gRarityOrder.map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join("");
  }
}

function renderTabs(){
  const tabs=$("#gachaTabs"); if(!tabs) return;
  tabs.innerHTML="";
  gAllGachas.forEach((g,idx)=>{
    const el=document.createElement("div");
    el.className="tab"+((selectedGacha?selectedGacha===g:idx===0)?" active":"");
    el.textContent=g; el.dataset.gacha=g;
    el.addEventListener("click",()=>{ selectedGacha=g; $$(".tab",tabs).forEach(t=>t.classList.toggle("active",t.dataset.gacha===g)); renderItemGrid(); });
        // å³ä¸Š Ã— ãƒœã‚¿ãƒ³
    const x=document.createElement("button");
    x.type="button";
    x.className="close";
    x.textContent="Ã—";
    x.title="ã“ã®ã‚¬ãƒãƒ£ã‚’å‰Šé™¤";
    x.addEventListener("click",(ev)=>{
      ev.stopPropagation();
      openDeleteConfirm(g);
    });
    el.appendChild(x);

    tabs.appendChild(el);
  });

  // ï¼‹ãƒœã‚¿ãƒ³ï¼šæ–°ã—ã„ã‚¬ãƒãƒ£ã‚’è¿½åŠ ï¼ˆé–‹å§‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰
  const add=document.createElement("div");
  add.className="tab add";
  add.title="ã‚¬ãƒãƒ£ã®ç¨®é¡ã‚’è¿½åŠ ";
  add.textContent="ï¼‹";
  add.style.fontWeight="800";
  add.style.borderStyle="solid";
  add.addEventListener("click", ()=> open(startModal));
  tabs.appendChild(add);

  if(!selectedGacha && gAllGachas.length) selectedGacha=gAllGachas[0];
}

function renderItemGrid(){
  const grid=$("#itemGrid"); if(!grid){ return; }
  grid.innerHTML="";
  if(!selectedGacha){ grid.textContent="ã‚¬ãƒãƒ£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é–‹å§‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å®šç¾©ã¾ãŸã¯JSONã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚"; return; }
  const rFilter=$("#filterRarity").value;
  const list=(gItemsByGacha[selectedGacha]||[]).filter(it=>rFilter==="*"||it.rarity===rFilter);
  for(const it of list){
    const key=keyOf(it.gacha,it.rarity,it.code);
    const skipped=skipHas(key);
    const hasImage=!!lookupVal(imgMap,key);
    const card=document.createElement("div"); card.className="item-card";
    card.innerHTML=`
      <div class="item-thumb" data-thumb-key="${key}">${thumbInnerHTML(it)}</div>
      <div class="item-code">${escapeHtml(it.code)}</div>
      <div class="muted"><span class="rarity ${it.rarity}">${it.rarity}</span></div>
      <div class="card-actions">
        <button class="btn" data-action="primary"${skipped?' disabled':''}>${hasImage?'è§£é™¤':'ğŸ–¼ï¸ ç”»åƒè¨­å®š'}</button>
        <button class="btn ghost" data-action="skip">${skipped?"ãƒªã‚¢ã‚°è§£é™¤":"ãƒªã‚¢ã‚°"}</button>
      </div>
      <div class="flag"><span class="badge">${it.gacha} / ${it.rarity}:${escapeHtml(it.code)}</span>${skipped?'<span class="badge skip">ãƒªã‚¢ã‚°</span>':""}</div>`;
    card.querySelector('[data-action="primary"]').addEventListener("click",()=>{ const nowHas=!!lookupVal(imgMap,key); if(nowHas){ clearImage(it); } else { openImageModal(it); }});
    card.querySelector('[data-action="skip"]').addEventListener("click",()=>toggleSkip(it));
    grid.appendChild(card);
  }
  resolveThumbs(grid);
}

function renderUsersList(){
  const wrap=$("#usersList"); if(!wrap) return;
  wrap.innerHTML="";
  const empty = Object.keys(gData).length===0;
  if(empty){ wrap.innerHTML='<div class="muted">ã¾ã ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é–‹å§‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ãŸã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ã‹ã‚‰åæ˜ ã—ã¦ãã ã•ã„ã€‚</div>'; return; }

  const gachaFilter=$("#filterGacha").value, rFilter=$("#filterRarity").value, hideMiss=$("#hideMiss").checked, q=($("#userSearch").value||"").trim();
  const showCounts = $("#showCounts")?.checked;
  const showSkipOnly = $("#showSkipOnly")?.checked;
  
  Object.entries(gData).forEach(([user,gobj])=>{
    if(q && !user.includes(q)) return;

    const card=document.createElement("div"); card.className="user-card panel";
    const header=document.createElement("div"); header.className="user-header";
    header.innerHTML=`<h2>${escapeHtml(user)}</h2>
      <div class="user-actions"><button class="btn small" data-zip-save>ä¿å­˜</button></div>`;
    card.appendChild(header);

    // ä¿å­˜ï¼ˆFile System Access APIï¼‰
    header.querySelector('[data-zip-save]').addEventListener('click', async (e)=>{
    if (typeof JSZip === "undefined") { alert("JSZipã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚"); return; }

    const btn = e.currentTarget; const old = btn.textContent;
    btn.disabled = true; btn.textContent = "ä¿å­˜æº–å‚™â€¦";

    try{
      const { blob } = await buildZipForUser(user, gobj);
      const filename = `${sanitize(user)}_gacha.zip`;

      // 1) File System Access APIï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— Chrome/Edge ç­‰ï¼‰
      if ('showSaveFilePicker' in window) {
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description: 'ZIP archive', accept: { 'application/zip': ['.zip'] } }]
        });
        const w = await handle.createWritable();
        await w.write(blob); await w.close();
        btn.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
        setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1200);
        return;
      }

      // 2) Web Share Level 2ï¼ˆiOS/Android ã®å…±æœ‰ã‚·ãƒ¼ãƒˆ â†’ ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€ç­‰ï¼‰
      if (navigator.canShare) {
        const file = new File([blob], filename, { type: 'application/zip' });
        if (navigator.canShare({ files:[file] })) {
          await navigator.share({ files:[file], title: filename });
          btn.textContent = "å…±æœ‰ã—ã¾ã—ãŸ";
          setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1200);
          return;
        }
      }

      // 3) ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆiOS/Android Safari/Chrome ã®ä¿å­˜ï¼‰
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
      btn.textContent = "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹";
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1200);

    }catch(err){
      console.error(err);
      btn.disabled = false; btn.textContent = old;
      alert("ä¿å­˜ã«å¤±æ•—: " + (err?.message || err));
    }
    });
    
    let hasAnyBox = false; 
    Object.entries(gobj).forEach(([gacha,info])=>{
      if(gachaFilter!=="*" && gachaFilter!==gacha) return;
      const box=document.createElement("div"); box.className="gacha-box";
      const pulls=info.pulls??0; box.innerHTML=`<div><strong>${escapeHtml(gacha)}</strong> <span class="tag">${pulls}é€£</span></div>`;
      const items=info.items||{};
      let boxHasAny = false;
      
      gRarityOrder.forEach(rarity=>{
        let list = (items[rarity] || []);
        if(showSkipOnly){
          list = list.filter(code => skipHas(keyOf(gacha, rarity, code)));
        }
        if(!list.length) return; 
        if(hideMiss && rarity==="ã¯ãšã‚Œ") return; 
        if(rFilter!=="*" && rFilter!==rarity) return; //

        const row=document.createElement("div"); row.className="rarity-row";
        const label=document.createElement("span"); label.className=`rarity-label rarity ${rarity}`; label.textContent=rarity;
        const itemsWrap=document.createElement("div"); itemsWrap.className="rarity-items";

        list.forEach(code=>{
          const key=keyOf(gacha,rarity,code);
          const pill=document.createElement("span");
          const v=lookupVal(imgMap,key);
          const immediate=v && !v.startsWith("idb:") ? v : "";
          const countVal = showCounts ? (((gHitCounts[user]||{})[gacha]||{})[rarity]||{})[code] : null;

          pill.className="item-pill"+(immediate?"":" no-img");
          pill.dataset.imgKey = key;
          pill.dataset.user  = user;
          pill.dataset.gacha = gacha;
          pill.dataset.rarity= rarity;
          pill.dataset.code  = code;

          const labelHtml = `<span>${escapeHtml(code)}</span>${(countVal!=null)?`<span class="count">Ã—${countVal}</span>`:""}`;

          if(immediate){
            pill.innerHTML=`<img alt="${escapeHtml(code)}" src="${immediate}"/>${labelHtml}`;
          }else{
            pill.innerHTML=labelHtml;
          }
          itemsWrap.appendChild(pill);
        });

        if(itemsWrap.children.length){
        row.appendChild(label); row.appendChild(itemsWrap); box.appendChild(row);
        boxHasAny = true;
        }
      });
      if(boxHasAny){ card.appendChild(box); hasAnyBox = true; }
    });

    if(hasAnyBox){ wrap.appendChild(card); } // â˜… å¯¾è±¡ãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‡ºã•ãªã„
  });
  resolvePills(wrap);
}

/* ====== å±¥æ­´ã‚’è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
const appendModal = $("#appendModal");

$("#openAppend").addEventListener("click", ()=>{
  const sel = $("#appendGacha");
  sel.innerHTML = gAllGachas.map(g=>`<option>${g}</option>`).join("");
  open(appendModal);
});
$("#appendClose").addEventListener("click", ()=>close(appendModal));

$("#appendApply").addEventListener("click", ()=>{
  const gacha = ($("#appendGacha").value||"").trim();
  const text  = ($("#appendText").value||"").trim();
  if(!gacha){ alert("ã‚¬ãƒãƒ£åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  if(!text){ alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); return; }

  const parsed = parseFinalSummaryText(text);
  if(parsed.length===0){ alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æˆç¸¾ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }

  const delta = {}, catSet = new Map();
  parsed.forEach(({user, entries})=>{
    delta[user] = delta[user] || {};
    delta[user][gacha] = delta[user][gacha] || {pulls:0, items:{}};
    let pulls = 0;
    entries.forEach(({rarity, code, count})=>{
      pulls += (+count||0);
      delta[user][gacha].items[rarity] = delta[user][gacha].items[rarity] || [];
      uniqPush(delta[user][gacha].items[rarity], code);
      catSet.set(keyOf(gacha,rarity,code), {gacha,rarity,code});
      incCount(user, gacha, rarity, code, +count||0); // ç²å¾—æ•°ã‚‚åæ˜ 
    });
    delta[user][gacha].pulls += pulls;
  });

  gCatalogByGacha[gacha] = Array.from(catSet.values()).sort(byRarityThenCode);
  mergeIntoGData(delta);

  rebuildGachaCaches(); renderTabs(); renderItemGrid(); renderUsersList();
  close(appendModal);
});

/* ====== ã‚¬ãƒãƒ£ã‚¿ãƒ–å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
const deleteModal = $("#deleteModal");
let pendingDeleteGacha = null;

function openDeleteConfirm(gacha){
  pendingDeleteGacha = gacha;
  $("#delTarget").textContent = gacha;
  open(deleteModal);
}
$("#delCancel").addEventListener("click", ()=>{ pendingDeleteGacha=null; close(deleteModal); });
$("#delConfirm").addEventListener("click", ()=>{
  const g = pendingDeleteGacha; pendingDeleteGacha=null; close(deleteModal);
  if(!g) return;
  // ã‚«ã‚¿ãƒ­ã‚°ã‹ã‚‰å‰Šé™¤
  delete gCatalogByGacha[g];
  // é›†è¨ˆã‹ã‚‰å‰Šé™¤ & ã‚«ã‚¦ãƒ³ãƒˆã‚‚å‰Šé™¤
  for(const user of Object.keys(gData)){
    if(gData[user] && gData[user][g]) delete gData[user][g];
    if(gHitCounts[user] && gHitCounts[user][g]) delete gHitCounts[user][g];
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ã‚¬ãƒãƒ£ãŒç„¡ããªã£ãŸã‚‰ç©ºã‚’æƒé™¤
    if(gData[user] && Object.keys(gData[user]).length===0) delete gData[user];
  }
  // é¸æŠã‚¬ãƒãƒ£ã®èª¿æ•´
  if(selectedGacha === g) selectedGacha = null;
  rebuildGachaCaches();
  renderTabs(); renderItemGrid(); renderUsersList();
});

/* ====== ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¢å­˜ï¼‰ ====== */
const imageModal=$("#imageModal"); let tempPreviewURL="";
function openImageModal(it){
  const k=keyOf(it.gacha,it.rarity,it.code); if(skipHas(k)) return;
  currentModalTarget=it; $("#modalTarget").textContent=`${it.gacha} / ${it.rarity}:${it.code}`;
  const cur=immediateSrcFor(k); $("#modalPreview").src=cur||""; $("#modalStatus").textContent=(lookupVal(imgMap,k)?"è¨­å®šæ¸ˆã¿":"æœªè¨­å®š");
  $("#fileInput").value=""; $("#urlInput").value=(cur && !cur.startsWith("data:"))?cur:"";
  imageModal.classList.add("show"); imageModal.setAttribute("aria-hidden","false");
}
function closeImageModal(){ imageModal.classList.remove("show"); imageModal.setAttribute("aria-hidden","true"); if(tempPreviewURL){ URL.revokeObjectURL(tempPreviewURL); tempPreviewURL=""; } }
$("#closeBtn").addEventListener("click", closeImageModal);
imageModal.addEventListener("click",(e)=>{ if(e.target===imageModal) closeImageModal(); });

$("#fileInput").addEventListener("change", async ()=>{
  if(tempPreviewURL){ URL.revokeObjectURL(tempPreviewURL); tempPreviewURL=""; }
  const file=$("#fileInput").files[0]; if(!file){ $("#modalPreview").src=""; return; }
  const kind=getFileKind(file);
  try{
    if(kind==="image"){ tempPreviewURL=URL.createObjectURL(file); $("#modalPreview").src=tempPreviewURL; $("#modalStatus").textContent="æœªä¿å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç”»åƒï¼‰"; return; }
    if(kind==="audio"){ const blob=await makeNotePlaceholder(256); tempPreviewURL=URL.createObjectURL(blob); $("#modalPreview").src=tempPreviewURL; $("#modalStatus").textContent="æœªä¿å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆéŸ³å£°:â™«ï¼‰"; return; }
    if(kind==="video"){ const thumb=await extractVideoThumbnail(file,{time:0.1,maxSize:256}); tempPreviewURL=URL.createObjectURL(thumb); $("#modalPreview").src=tempPreviewURL; $("#modalStatus").textContent="æœªä¿å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå‹•ç”»ã‚µãƒ ãƒï¼‰"; return; }
  }catch(e){ const ph=await makeFilmPlaceholder(256); tempPreviewURL=URL.createObjectURL(ph); $("#modalPreview").src=tempPreviewURL; $("#modalStatus").textContent="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰"; }
});
$("#urlInput").addEventListener("input", ()=>{ const url=($("#urlInput").value||"").trim(); if(url){ $("#modalPreview").src=url; $("#modalStatus").textContent="æœªä¿å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆURLï¼‰"; } });

$("#applyBtn").addEventListener("click", async ()=>{
  if(!currentModalTarget) return;
  const k=keyOf(currentModalTarget.gacha,currentModalTarget.rarity,currentModalTarget.code);
  const file=$("#fileInput").files[0]; const url=($("#urlInput").value||"").trim();
  try{
    if(file){
      const kind=getFileKind(file);
      await idbPut(k+"|orig", file);           // ã‚ªãƒªã‚¸ãƒŠãƒ«
      origMap[k] = "idb:" + (k+"|orig");
      let thumbBlob=null;
      if(kind==="image"){ thumbBlob = await compressImage(file,{maxSize:256,typePrefer:["image/webp","image/jpeg"],quality:0.85}); }
      else if(kind==="audio"){ thumbBlob = await makeNotePlaceholder(256); }
      else if(kind==="video"){ thumbBlob = await extractVideoThumbnail(file,{time:0.1,maxSize:256}); }
      await idbPut(k+"|thumb", thumbBlob); imgMap[k]="idb:"+(k+"|thumb");
      saveLocalJSON(LS_KEY_IMG,imgMap); saveLocalJSON(LS_KEY_ORIG,origMap);
    }else if(url){
      let ok=false;
      try{
        const resp = await fetch(url,{mode:"cors"}); const blob = await resp.blob();
        await idbPut(k+"|orig", blob); origMap[k] = "idb:"+(k+"|orig");
        const kind = blob.type.startsWith("image/") ? "image" : blob.type.startsWith("video/") ? "video" : blob.type.startsWith("audio/") ? "audio" : "unknown";
        let thumbBlob=null;
        if(kind==="image"){ thumbBlob = await compressImage(blob,{maxSize:256,typePrefer:["image/webp","image/jpeg"],quality:0.85}); }
        else if(kind==="audio"){ thumbBlob = await makeNotePlaceholder(256); }
        else if(kind==="video"){ thumbBlob = await extractVideoThumbnail(blob,{time:0.1,maxSize:256}); }
        if(thumbBlob){ await idbPut(k+"|thumb", thumbBlob); imgMap[k]="idb:"+(k+"|thumb"); ok=true; }
      }catch(_e){}
      if(!ok){ imgMap[k]=url; }
      saveLocalJSON(LS_KEY_IMG,imgMap); saveLocalJSON(LS_KEY_ORIG,origMap);
    }else{ alert("ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯URLã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"); return; }
    closeImageModal(); renderItemGrid(); renderUsersList();
  }catch(err){ console.error(err); alert("ä¿å­˜ã«å¤±æ•—: "+(err?.message||err)); }
});

/* ====== è§£é™¤ï¼ãƒªã‚¢ã‚° ====== */
async function clearImage(it){
  const kNew=keyOf(it.gacha,it.rarity,it.code), kOld=legacyKey(it.rarity,it.code);
  for(const k of [kNew,kOld]){
    const v=imgMap[k]; if(v && v.startsWith("idb:")){ const real=v.slice(4); await idbDelete(real); if(urlCache.has(real)){ URL.revokeObjectURL(urlCache.get(real)); urlCache.delete(real); } }
    const o=origMap[k]; if(o && o.startsWith("idb:")){ await idbDelete(o.slice(4)); }
    delete imgMap[k]; delete origMap[k];
  }
  saveLocalJSON(LS_KEY_IMG,imgMap); saveLocalJSON(LS_KEY_ORIG,origMap);
  renderItemGrid(); renderUsersList();
}
async function toggleSkip(it){ const k=keyOf(it.gacha,it.rarity,it.code); if(skipHas(k)){ skipDel(k); } else { await clearImage(it); skipAdd(k); } renderItemGrid(); }

/* ====== ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è§£æ±º ====== */
async function resolveThumbs(root=document){
  const nodes=$$('[data-thumb-key]',root);
  await Promise.all(nodes.map(async el=>{
    const key=el.getAttribute('data-thumb-key'); if(!key) return;
    if(immediateSrcFor(key)) return;
    const v=lookupVal(imgMap,key); if(v && v.startsWith("idb:")){ const idbKey=v.slice(4); const url=await urlForKey(idbKey); if(url){ el.innerHTML=`<img src="${url}" alt="${escapeHtml(key.split('::')[2]||'item')}" />`; } }
  }));
}

async function resolvePills(root=document){
  const nodes=$$('[data-img-key]',root);
  const showCounts = $("#showCounts")?.checked;

  await Promise.all(nodes.map(async el=>{
    const key=el.dataset.imgKey;
    const v=lookupVal(imgMap,key);
    if(!v) return;

    const user  = el.dataset.user;
    const gacha = el.dataset.gacha;
    const rarity= el.dataset.rarity;
    const code  = el.dataset.code;
    const countVal = showCounts ? (((gHitCounts[user]||{})[gacha]||{})[rarity]||{})[code] : null;
    const labelHtml = `<span>${escapeHtml(code)}</span>${(countVal!=null)?`<span class="count">Ã—${countVal}</span>`:""}`;

    if(v.startsWith("idb:")){
      const url=await urlForKey(v.slice(4));
      if(url){ el.classList.remove("no-img"); el.innerHTML=`<img alt="${escapeHtml(code)}" src="${url}"/>${labelHtml}`; }
    }else{
      el.classList.remove("no-img");
      el.innerHTML=`<img alt="${escapeHtml(code)}" src="${v}"/>${labelHtml}`;
    }
  }));
}

/* ====== ZIPä½œæˆï¼ˆä¿å­˜ç”¨ï¼‰ ====== */
async function buildZipForUser(user, gobj){
  const zip = new JSZip(); const usedNames = new Set(); let count = 0;
  for(const [gacha,info] of Object.entries(gobj)){
    const itemObj = info.items || {};
  for(const rarity of Object.keys(itemObj)){
      for(const code of (itemObj[rarity] || [])){
        const key = keyOf(gacha, rarity, code);
        if(skipHas(key)) continue;
        const blob = await getOriginalBlobForKey(key);
        if(!blob) continue;
        const ext = guessExt(blob.type) || "bin";
        const base = `${sanitize(gacha)}/${rarity}_${sanitize(code)}.${ext}`;
        let name = base, i=2; while(usedNames.has(name)){ name = base.replace(`.${ext}`, `(${i++}).${ext}`); }
        usedNames.add(name);
        zip.file(name, blob, {binary:true, compression:"STORE"});
        count++;
      }
    }
  }
  if(count === 0) throw new Error("å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆç”»åƒæœªè¨­å®š or ã™ã¹ã¦ãƒªã‚¢ã‚°ï¼‰");
  const blob = await zip.generateAsync({type:"blob", compression:"STORE"});
  return {blob, count, size: blob.size};
}

async function getOriginalBlobForKey(key){
  const orig = origMap[key];
  if(orig && orig.startsWith("idb:")){ const b = await idbGet(orig.slice(4)); if(b) return b; }
  const v = lookupVal(imgMap, key);
  if(v && v.startsWith("idb:")){ const b = await idbGet(v.slice(4)); if(b) return b; }
  if(v && /^https?:|^data:/.test(v)){ try{ const res = await fetch(v,{mode:"cors"}); const b = await res.blob(); return b; }catch(_e){ return null; } }
  return null;
}

const guessExt = (mime) => {
  if(!mime) return "";
  if(mime==="image/jpeg") return "jpg";
  const map = { "image/png":"png","image/webp":"webp","image/gif":"gif","image/svg+xml":"svg",
                "video/mp4":"mp4","video/webm":"webm","audio/mpeg":"mp3","audio/wav":"wav","audio/mp4":"m4a" };
  return map[mime] || (mime.split("/")[1]||"");
};

/* ====== ç”»åƒå‡¦ç†è£œåŠ© ====== */
function getFileKind(file){ const t=(file.type||"").toLowerCase(); const n=(file.name||"").toLowerCase();
  if(t.startsWith("image/")) return "image";
  if(t.startsWith("video/")||n.endsWith(".mp4")||n.endsWith(".webm")||n.endsWith(".mov")) return "video";
  if(t.startsWith("audio/")||n.endsWith(".mp3")||n.endsWith(".wav")||n.endsWith(".m4a")) return "audio";
  return "unknown"; }
async function makeNotePlaceholder(size=256){ const c=document.createElement("canvas"); c.width=c.height=size; const x=c.getContext("2d");
  x.fillStyle="#0e0f14"; x.fillRect(0,0,size,size); x.fillStyle="#1f2937"; x.beginPath(); x.arc(size*.5,size*.5,size*.42,0,Math.PI*2); x.fill();
  x.fillStyle="#e11d48"; x.font=`${Math.round(size*.5)}px system-ui,-apple-system,"Segoe UI",Roboto,"Noto Color Emoji"`; x.textAlign="center"; x.textBaseline="middle"; x.fillText("â™«", size*.5, size*.5);
  return await new Promise(r=>c.toBlob(r,"image/png")); }
async function makeFilmPlaceholder(size=256){ const c=document.createElement("canvas"); c.width=c.height=size; const x=c.getContext("2d");
  x.fillStyle="#0e0f14"; x.fillRect(0,0,size,size); x.strokeStyle="#e11d48"; x.lineWidth=Math.max(2,size*.04); x.strokeRect(size*.15,size*.25,size*.7,size*.5);
  for(let i=0;i<4;i++){ x.fillStyle="#1f2937"; x.fillRect(size*(0.18+i*0.18), size*0.18, size*0.08, size*0.05); x.fillRect(size*(0.18+i*0.18), size*0.77, size*0.08, size*0.05); }
  return await new Promise(r=>c.toBlob(r,"image/png")); }
async function extractVideoThumbnail(fileOrBlob,{time=0.1,maxSize=256}={}){ const url=URL.createObjectURL(fileOrBlob);
  try{ const v=document.createElement("video"); v.preload="metadata"; v.src=url; v.muted=true;
    await new Promise((ok,ng)=>{ v.onloadedmetadata=()=>ok(); v.onerror=()=>ng(new Error("metadata load failed")); });
    v.currentTime=Math.min(Math.max(time,0.01),(v.duration||1)-0.01); await new Promise(ok=>{ v.onseeked=()=>ok(); });
    const w=v.videoWidth,h=v.videoHeight,s=Math.min(1,maxSize/Math.max(w,h)); const tw=Math.max(1,Math.round(w*s)), th=Math.max(1,Math.round(h*s));
    const c=document.createElement("canvas"); c.width=tw; c.height=th; c.getContext("2d").drawImage(v,0,0,tw,th); URL.revokeObjectURL(url);
    return await new Promise(r=>c.toBlob(r,"image/webp",0.85));
  }catch(e){ URL.revokeObjectURL(url); return await makeFilmPlaceholder(maxSize); } }
async function compressImage(fileOrBlob,{maxSize=256,typePrefer=["image/webp","image/jpeg"],quality=0.85}={}){
  const img=await createImageBitmap(fileOrBlob).catch(()=>null); const tag=img?null:await fileToImage(fileOrBlob);
  const w=img?img.width:tag.naturalWidth, h=img?img.height:tag.naturalHeight, s=Math.min(1,maxSize/Math.max(w,h));
  const tw=Math.max(1,Math.round(w*s)), th=Math.max(1,Math.round(h*s));
  const c=document.createElement("canvas"); c.width=tw; c.height=th; c.getContext("2d").drawImage(img||tag,0,0,tw,th);
  for(const mime of typePrefer){ const b=await new Promise(r=>c.toBlob(r,mime,quality)); if(b) return b; } return await new Promise(r=>c.toBlob(r,"image/png"));
}
function fileToImage(file){ return new Promise((ok,ng)=>{ const fr=new FileReader(); fr.onload=()=>{ const img=new Image(); img.onload=()=>ok(img); img.onerror=ng; img.src=fr.result; }; fr.onerror=ng; fr.readAsDataURL(file); }); }

/* ====== é–‹å§‹ãƒ•ãƒ­ãƒ¼ UIï¼ˆå …ç‰¢ç‰ˆï¼‰ ====== */
const splash = $("#splash"), mainUI = $("#mainUI");
const startModal = $("#startModal"), catalogModal = $("#catalogModal"),
      liveModal = $("#liveModal"), finalModal = $("#finalModal"),
      guideModal = $("#guideModal");

let modalCount = 0;
function open(modal){
  if (!modal) return;
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");
  if (++modalCount === 1) document.body.classList.add("modal-open");
}
function close(modal){
  if (!modal || !modal.classList.contains("show")) return;
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
  if (--modalCount <= 0){ modalCount = 0; document.body.classList.remove("modal-open"); }
}
function startDone(){
  if (splash) splash.style.display = "none";
  if (mainUI) mainUI.style.display = "block";
  document.body.classList.remove('splash-locked');
  close(startModal);
}

/* â–¼ DOMæ§‹ç¯‰å¾Œã«å®‰å…¨ã«ãƒã‚¤ãƒ³ãƒ‰ */
document.addEventListener('DOMContentLoaded', () => {
  $("#openStart")?.addEventListener("click", ()=> open(startModal));
  $("#closeStart")?.addEventListener("click", ()=> close(startModal));

  $("#tileJson")?.addEventListener("click", ()=> $("#jsonFile2")?.click());
  $("#tileTxt")?.addEventListener("click",  ()=> $("#txtFileInput")?.click());
  $("#tileLive")?.addEventListener("click", ()=> open(catalogModal));
  $("#tileFinal")?.addEventListener("click", ()=> open(finalModal));

  $("#jsonFile2")?.addEventListener("change", ()=>{
    const inp = $("#jsonFile2");
    const f = inp?.files?.[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = () => {
      try {
        onJsonLoaded(JSON.parse(rd.result));
        startDone();
      } catch (err) {
        alert("JSONã®è§£æã«å¤±æ•—: " + (err?.message || err));
      } finally {
        if (inp) inp.value = "";
      }
    };
    rd.readAsText(f, "utf-8");

  });

  $("#catClose").addEventListener("click", ()=>close(catalogModal));
  $("#openLivePaste").addEventListener("click", ()=>open(liveModal));
  $("#liveClose").addEventListener("click", ()=>close(liveModal));
  $("#finalClose").addEventListener("click", ()=>close(finalModal));


  // TXT(.txt) ã‚’é¸æŠ â†’ base64(raw deflate) â†’ JSON â†’ å–ã‚Šè¾¼ã¿
  $("#txtFileInput")?.addEventListener("change", async (ev)=>{
    const inp = ev.currentTarget;
    const f = ev.target.files?.[0]; if (!f) return;
    try{
      if (typeof pako === "undefined") throw new Error("pako ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      const b64 = (await f.text()).trim();
      const bytes = b64ToBytes(b64);                 // â€» URL-safe/æ”¹è¡Œé™¤å»ç‰ˆã‚’ä½¿ç”¨
      const jsonStr = pako.inflateRaw(bytes, { to: "string" }); // â˜… raw ãŒå¿…é ˆ
      const state = JSON.parse(jsonStr);
      await importFromExternalState(state);          // â€» ã“ã®ä¸­ã§ startDone() æ¸ˆã¿
    }catch(err){
      console.error(err);
      alert("TXTã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err?.message || err));
    }finally{
      if (inp) inp.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€£ç¶šé¸æŠå¯
    }
  });
});



/* ====== 1) ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼šã‚«ã‚¿ãƒ­ã‚°è§£æ â†’ åæ˜  ====== */
$("#catParse").addEventListener("click", ()=>{
  const gacha = ($("#catGachaName").value||"").trim() || "ã‚¬ãƒãƒ£";
  const text  = ($("#catText").value||"").trim();
  if(!text){ alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); return; }
  const items = parseCatalogText(text);
  if(items.length===0){ alert("ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"); return; }
  // åæ˜ ï¼šã‚«ã‚¿ãƒ­ã‚°ã¨ã—ã¦ç™»éŒ²
  const arr = [];
  items.forEach(({rarity, code})=>{
    arr.push({gacha, rarity, code});
  });
  gCatalogByGacha[gacha] = arr;
  selectedGacha = gacha;
  rebuildGachaCaches(); renderTabs(); renderItemGrid(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç©ºã§ã‚‚OK
  startDone(); close(catalogModal);
  // æ¬¡ï¼šãƒ©ã‚¤ãƒ–è²¼ã‚Šä»˜ã‘ã‚’ä¿ƒã™
  open(guideModal);
});

/* ====== 1.5) ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ====== */
$("#guideOk").addEventListener("click", ()=>close(guideModal));

/* ====== 2) ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼šçµæœè²¼ã‚Šä»˜ã‘ï¼ˆç¹°ã‚Šè¿”ã—å¯ï¼‰ ====== */
$("#liveApply").addEventListener("click", () => {
  const text = ($("#liveText").value || "").trim();
  if (!text) { alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); return; }

  const blocks = splitLiveBlocks(text);
  if (blocks.length === 0) { alert("è§£æã§ãã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }

  const delta = {};
  let lastGacha = null;
  let added = 0;

  for (const block of blocks) {
    const parsed = parseLiveBlock(block);
    if (!parsed) continue;

    const { gacha, user, pulls, items } = parsed;
    lastGacha = gacha;

    // deltaã«ç©ã‚€
    delta[user] = delta[user] || {};
    delta[user][gacha] = delta[user][gacha] || { pulls: 0, items: {} };
    delta[user][gacha].pulls += pulls;

    // ç²å¾—æ•°ï¼ˆcountsï¼‰ã‚’åŠ ç®—
    if (parsed.counts) {
      for (const [rarity, byCode] of Object.entries(parsed.counts)) {
        for (const [code, num] of Object.entries(byCode)) {
          incCount(user, gacha, rarity, code, num);
        }
      }
    }

    for (const [rarity, codes] of Object.entries(items)) {
      delta[user][gacha].items[rarity] = delta[user][gacha].items[rarity] || [];
      codes.forEach(c => { if (!delta[user][gacha].items[rarity].includes(c)) delta[user][gacha].items[rarity].push(c); });
    }

    // ã‚«ã‚¿ãƒ­ã‚°ã‚‚æ›´æ–°ï¼ˆæœªç™»éŒ²ã‚¢ã‚¤ãƒ†ãƒ ã®è£œå®Œï¼‰
    const cat = gCatalogByGacha[gacha] || [];
    const map = new Map(cat.map(it => [ `${it.gacha}::${it.rarity}::${it.code}`, it ]));
    Object.entries(items).forEach(([rarity, codes]) => {
      codes.forEach(code => {
        const k = `${gacha}::${rarity}::${code}`;
        if (!map.has(k)) map.set(k, { gacha, rarity, code });
      });
    });
    gCatalogByGacha[gacha] = Array.from(map.values()).sort(byRarityThenCode);

    added++;
  }

  if (!added) { alert("ãƒ–ãƒ­ãƒƒã‚¯ã¯è¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"); return; }

  // gDataã¸ãƒãƒ¼ã‚¸ â†’ å†æç”»
  mergeIntoGData(delta);
  if (lastGacha) selectedGacha = lastGacha;

  $("#liveText").value = "";
  close(liveModal);          // â† åæ˜ å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  startDone();               // â† ã¾ã ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥è¡¨ç¤ºãªã‚‰é€šå¸¸ç”»é¢ã¸
  rebuildGachaCaches();
  renderTabs();
  renderItemGrid();
  renderUsersList();
});

/* ====== 3) æœ€çµ‚çµæœï¼šä¸€æ‹¬è²¼ã‚Šä»˜ã‘ â†’ åæ˜  ====== */
$("#finalParse").addEventListener("click", ()=>{
  const gacha = ($("#finalGachaName").value||"").trim() || "ã‚¬ãƒãƒ£";
  const text = ($("#finalText").value||"").trim();
  if(!text){ alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); return; }
  const parsed = parseFinalSummaryText(text);
  if(parsed.length===0){ alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æˆç¸¾ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }

  const delta = {}, catSet = new Map();
  parsed.forEach(({user, entries})=>{
    delta[user] = delta[user] || {};
    delta[user][gacha] = delta[user][gacha] || {pulls:0, items:{}};
    let pulls = 0;
    entries.forEach(({rarity, code, count})=>{
      pulls += (+count||0);
      delta[user][gacha].items[rarity] = delta[user][gacha].items[rarity] || [];
      uniqPush(delta[user][gacha].items[rarity], code);
      catSet.set(keyOf(gacha,rarity,code), {gacha,rarity,code});
      incCount(user, gacha, rarity, code, +count||0);
    });
    delta[user][gacha].pulls += pulls;
  });

  // ã‚«ã‚¿ãƒ­ã‚°åæ˜ 
  gCatalogByGacha[gacha] = Array.from(catSet.values()).sort(byRarityThenCode);

  mergeIntoGData(delta);
  rebuildGachaCaches(); renderTabs(); renderItemGrid(); renderUsersList();
  startDone(); close(finalModal);
});

/* ====== ãƒãƒ¼ã‚¸/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function mergeIntoGData(delta){
  for(const [user,gobj] of Object.entries(delta)){
    gData[user] = gData[user] || {};
    for(const [gacha,info] of Object.entries(gobj)){
      gData[user][gacha] = gData[user][gacha] || {pulls:0, items:{}};
      gData[user][gacha].pulls += (info.pulls||0);
      for(const [rarity,codes] of Object.entries(info.items||{})){
        gData[user][gacha].items[rarity] = gData[user][gacha].items[rarity] || [];
        codes.forEach(c=>uniqPush(gData[user][gacha].items[rarity], c));
      }
    }
  }
}

/* ====== è§£æ: å‡ºç¾ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ ======
   è¡Œã®ä¸¦ã³ãŒ â‘ ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼ˆ1\tR\t7.5%\tCï¼‰
            ã¾ãŸã¯ â‘¡ç¸¦4è¡Œï¼ˆ1 / R / 7.5% / Cï¼‰ ã‚’ä¸¡å¯¾å¿œ */
function parseCatalogText(text){
  const items = [];
  const clean = text.replace(/\r/g,'').replace(/[ \t]+\n/g,'\n').trim();
  // â‘  ã‚¿ãƒ–åŒºåˆ‡ã‚Š
  const reTab = /^\s*\d+\s*\t\s*([^\t]+)\t([^\t\n]+)\t([^\t\n]+)\s*$/gm;
  let m;
  while((m = reTab.exec(clean)) !== null){
    const rarity=(m[1]||"").trim(); const code=(m[3]||"").trim();
    if(rarity) items.push({rarity, code});
  }
  if(items.length>0) return items;

  // â‘¡ ç¸¦4è¡Œ
  const lines = clean.split(/\n+/);
  // ãƒ˜ãƒƒãƒ€é™¤å»
  while(lines.length && /No\./.test(lines[0])) lines.shift();
  while(lines.length && /ãƒ¬ã‚¢ãƒªãƒ†ã‚£|æ™¯å“å|å‡ºç¾ç‡/.test(lines[0])) lines.shift();

  for(let i=0;i+3<lines.length;i++){
    const a=lines[i].trim(), b=lines[i+1].trim(), c=lines[i+2].trim(), d=lines[i+3].trim();
    if(/^\d+$/.test(a) && b && d){ items.push({rarity:b, code:d}); i+=3; }
  }
  return items;
}

/* ====== è§£æ: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœï¼ˆ1ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ ====== */
function splitLiveBlocks(text){
  const clean = text.replace(/\r/g, '').trim();
  // ã€Œ#ãªã¾ãšã¤ãƒ¼ã‚‹ãšã€(æœ«å°¾ã«ç©ºç™½ãŒã‚ã£ã¦ã‚‚å¯) ã ã‘ã‚’åŒºåˆ‡ã‚Šã«æ¡ç”¨
  return clean
    .split(/#ãªã¾ãšã¤ãƒ¼ã‚‹ãš[^\S\r\n]*/g)
    .map(s => s.trim())
    .filter(Boolean);
}
function parseLiveBlock(block){
  const lines = block.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  if(lines.length<3) return null;
  const gacha = lines[0];
  const mUser = /^(.+?)\s*([0-9]+)\s*é€£$/.exec(lines[1]);
  if(!mUser) return null;
  const user = mUser[1].trim(); const pulls = parseInt(mUser[2],10)||0;
  const items = {};
  const counts = {}; // counts[rarity][code] = number

  for(let i=2;i<lines.length;i++){
    const line = lines[i];
    const m = /ã€([^ã€‘]+)ã€‘\s*([^\sã€€]+)[\sã€€]+(\d+)å€‹?/.exec(line);
    if(!m) continue;
    const rarity=m[1].trim(), code=m[2].trim(), num=parseInt(m[3],10)||0;
    items[rarity]=items[rarity]||[]; if(!items[rarity].includes(code)) items[rarity].push(code);
    counts[rarity]=counts[rarity]||{}; counts[rarity][code]=(counts[rarity][code]||0)+num;
  }
  return {gacha,user,pulls,items,counts};
}

/* ====== è§£æ: æœ€çµ‚çµæœä¸€è¦§ ======
   æ§‹é€ ï¼š (æ•°å­—) â†’ (ãƒ¦ãƒ¼ã‚¶ãƒ¼å) â†’ å¤šæ•°ã®ã€Œç•ªå·\tãƒ¬ã‚¢ãƒªãƒ†ã‚£\tæ™¯å“\tå€‹æ•°ã€è¡Œ â†’ æ¬¡ã® (æ•°å­—) ... */
function parseFinalSummaryText(text){
  const lines = text.replace(/\r/g,'').split(/\n/).map(s=>s.trim());
  const out = [];
  // ãƒ˜ãƒƒãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—
  let i=0; while(i<lines.length && (/^ã‚¬ãƒãƒ£$/.test(lines[i]) || /^No\./.test(lines[i]) || /åå‰$/.test(lines[i]) || /ãƒ¬ã‚¢ãƒªãƒ†ã‚£/.test(lines[i]))) i++;
  while(i<lines.length){
    // æ•°å­—è¡Œ
    if(!/^\d+$/.test(lines[i]||"")){ i++; continue; }
    i++;
    const user = (lines[i++]||"").trim(); if(!user){ continue; }
    const entries=[];
    while(i<lines.length){
      const s=lines[i];
      if(/^\d+$/.test(s)) break;  // æ¬¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
      const m=/^\s*\d+\s*\t\s*([^\t]+)\t([^\t]+)\t(\d+)\s*$/.exec(s);
      if(m){ entries.push({rarity:m[1].trim(), code:m[2].trim(), count:parseInt(m[3],10)||0}); i++; }
      else { i++; }
    }
    if(entries.length) out.push({user, entries});
  }
  return out;
}

/* ====== ãƒ•ã‚£ãƒ«ã‚¿ï¼†ãã®ä»–ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
$("#filterGacha").addEventListener("change", renderUsersList);
$("#filterRarity").addEventListener("change", ()=>{ renderItemGrid(); renderUsersList(); });
$("#hideMiss").addEventListener("change", renderUsersList);
$("#userSearch").addEventListener("input", renderUsersList);
$("#showCounts")?.addEventListener("change", renderUsersList);
$("#showSkipOnly")?.addEventListener("change", renderUsersList);

$("#exportMapBtn").addEventListener("click", async ()=>{
  const bundle={ images:imgMap, skip:Array.from(skipSet), original:origMap };
  const blob=new Blob([JSON.stringify(bundle,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="gacha_image_map_bundle.json"; document.body.appendChild(a); a.click(); a.remove();
});
$("#importMapInput").addEventListener("change", ()=>{
  const f=$("#importMapInput").files[0]; if(!f) return;
  const fr=new FileReader(); fr.onload=()=>{ try{
    const json=JSON.parse(fr.result);
    if(json.images&&typeof json.images==="object") imgMap=json.images; else if(typeof json==="object" && !json.original){ imgMap=json; }
    if(Array.isArray(json.skip)) skipSet=new Set(json.skip);
    if(json.original && typeof json.original==="object") origMap=json.original;
    saveLocalJSON(LS_KEY_IMG,imgMap); saveLocalJSON(LS_KEY_SKIP,Array.from(skipSet)); saveLocalJSON(LS_KEY_ORIG,origMap);
    renderItemGrid(); renderUsersList();
  }catch(e){ alert("ç”»åƒãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: "+e.message); } };
  fr.readAsText(f,"utf-8");
});
$("#clearMapBtn").addEventListener("click", async ()=>{
  if(confirm("ãƒ­ãƒ¼ã‚«ãƒ«ã®ç”»åƒãƒãƒƒãƒ—/ã‚ªãƒªã‚¸ãƒŠãƒ«/ãƒªã‚¢ã‚°è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    imgMap={}; origMap={}; skipSet=new Set();
    saveLocalJSON(LS_KEY_IMG,imgMap); saveLocalJSON(LS_KEY_ORIG,origMap); saveLocalJSON(LS_KEY_SKIP,[]);
    await idbClear(); for(const url of urlCache.values()) URL.revokeObjectURL(url); urlCache.clear();
    renderItemGrid(); renderUsersList();
  }
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  });
}

// --- TXT(base64 + DEFLATE raw) ã‚’å¾©å…ƒã—ã¦å–ã‚Šè¾¼ã‚€ ---

// base64 â†’ Uint8Arrayï¼ˆURL-safe/æ”¹è¡Œã‚’é™¤å»ï¼‰
function b64ToBytes(b64){
  const s = (b64||"").replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
  const pad = s.length % 4 ? 4 - (s.length % 4) : 0;
  const bin = atob(s + '='.repeat(pad));
  const arr = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

// å¤–éƒ¨state(JSON) â†’ æ—¢å­˜æ§‹é€ ã¸å–ã‚Šè¾¼ã¿
async function importFromExternalState(state){
  try{
    // 1) ã‚¬ãƒãƒ£åã®æ±ºå®š
    const nameMap = state?.gacha_name_list || {};
    const selKey  = String(state?.gacha_select ?? Object.keys(nameMap)[0] ?? "0");
    const gacha   = nameMap[selKey] || "ã‚¬ãƒãƒ£";

    // 2) ã‚«ã‚¿ãƒ­ã‚°ï¼ˆitem_base Ã— rarity_baseï¼‰
    const rarityBase = Array.isArray(state?.gacha_data?.rarity_base) ? state.gacha_data.rarity_base : [];
    // ä½ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â†’ ãƒ¬ã‚¢åï¼ˆä¾‹: 0->"N"ï¼‰
    const rarityIdxToName = rarityBase.map(row => Array.isArray(row) ? String(row[0]) : String(row?.name||""));
    const itemBase = Array.isArray(state?.gacha_data?.item_base) ? state.gacha_data.item_base : [];

    const cat = [];
    for(const row of itemBase){
      // å½¢å¼: [rarityIndex, weight, itemName]
      const ridx = parseInt(row?.[0],10);
      const code = String(row?.[2] ?? "");
      if(!code) continue;
      const rarity = rarityIdxToName[ridx] || String(row?.[1] ?? "N"); // å¿µã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      cat.push({ gacha, rarity, code });
    }
    if(cat.length) gCatalogByGacha[gacha] = cat.sort(byRarityThenCode);

    // 3) å±¥æ­´ï¼ˆhistory_listï¼‰
    // å½¢å¼: [ [ userName, [ [itemId, rarityStr, itemName, count], ... ] ], ... ]
    const hist = Array.isArray(state?.gacha_data?.history_list) ? state.gacha_data.history_list : [];
    const delta = {};
    for(const pair of hist){
      const user  = String(pair?.[0] ?? "");
      const entries = Array.isArray(pair?.[1]) ? pair[1] : [];
      if(!user || !entries.length) continue;

      delta[user] = delta[user] || {};
      delta[user][gacha] = delta[user][gacha] || { pulls: 0, items: {} };

      let pulls = 0;
      for(const e of entries){
        // e: [id, rarity, itemName, count]
        const rarity = String(e?.[1] ?? "");
        const code   = String(e?.[2] ?? "");
        const n      = +e?.[3] || 0;
        if(!rarity || !code) continue;

        // items: ç¨®é¡ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
        const arr = (delta[user][gacha].items[rarity] ||= []);
        if(!arr.includes(code)) arr.push(code);

        // ç²å¾—æ•°ï¼†pulls
        incCount(user, gacha, rarity, code, n);
        pulls += n;

        // ã‚«ã‚¿ãƒ­ã‚°è£œå®Œï¼ˆhistory ã«ã—ã‹ç„¡ã„åç§°ã‚‚æ‹¾ã†ï¼‰
        if(!gCatalogByGacha[gacha]){
          gCatalogByGacha[gacha] = [{gacha,rarity,code}];
        }else{
          const k = keyOf(gacha,rarity,code);
          // æ—¢å­˜ã«ç„¡ã‘ã‚Œã°è¿½åŠ 
          if(!(gCatalogByGacha[gacha].some(it => keyOf(it.gacha,it.rarity,it.code) === k))){
            gCatalogByGacha[gacha].push({gacha,rarity,code});
          }
        }
      }
      delta[user][gacha].pulls += pulls;
    }

    if(Object.keys(delta).length){
      // ã‚«ã‚¿ãƒ­ã‚°ã®ã‚½ãƒ¼ãƒˆ
      if(Array.isArray(gCatalogByGacha[gacha])) {
        gCatalogByGacha[gacha].sort(byRarityThenCode);
      }
      // ãƒãƒ¼ã‚¸â†’å†æç”»
      mergeIntoGData(delta);
    }

    rebuildGachaCaches(); renderTabs(); renderItemGrid(); renderUsersList();
    startDone(); close(startModal);
  }catch(err){
    console.error(err);
    alert("å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err?.message || err));
  }
}

</script>
</body>
</html>
